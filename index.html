<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tutta Notte Buia - MAalex</title>
    <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>

        @font-face {
            font-family: "Satoshi";
            font-weight: 100;
            src: url("./font/Satoshi-Variable.ttf") format("truetype");
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(40px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in-up {
            opacity: 0;
            animation: fadeInUp 3s ease-out forwards;
        }

        .fade-in {
            opacity: 0;
            animation: fadeIn 3s ease-in forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        .fade-out {
            animation: fadeOut 3s ease-out forwards;
        }

        #particles-js {
            position: fixed;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            z-index: -1;
            background-color: black;
            opacity: 0;
            transition: opacity 3s ease-in;
        }

</style>

    </style>
</head>
<body class="bg-black text-white font-mono overflow-hidden mt-[10vh] text-center" onload="getUserInfo(),initializePage()">

<div id="particles-js"></div>

    <div id="queueMessage" class="hidden flex flex-col justify-center items-center h-full w-full bg-black text-xl z-10">
      <p>It's not your time yet...</p>
    </div>

    <div id="rotateMessage" class="hidden absolute inset-0 bg-black/70 text-white flex justify-center items-center text-xl z-20">
      <p>Please rotate your device to continue</p>
    </div>

    <div id="infoScreen" class="hidden mt-[20vh]">
      <h1 id="welcomeMessage" class="fade-in-up font-[Satoshi] text-[150%]">Hi...</h1>
    </div>

    <div id="transitionScreen" class="hidden mt-[20vh]">
      <h1 id="transitionLine" class="fade-in-up font-[Satoshi] text-[150%]">Who is this?</h1>
    </div>

    <div id="formSection" class="hidden mt-[20vh]">
      <form id="userForm" class="flex flex-col items-center space-y-6">
        <div>
          <h1 class="fade-in font-[Satoshi] text-2xl">Name</h1>
          <input id="firstName" name="firstName" required type="text" class="fade-in bg-black border-b border-white text-white text-lg p-2 focus:outline-none" />
        </div>
        <div>
          <h1 class="fade-in font-[Satoshi] text-2xl">Surname</h1>
          <input id="lastName" name="lastName" required type="text" class="fade-in bg-black border-b border-white text-white text-lg p-2 focus:outline-none" />
        </div>
        <div>
          <h1 class="fade-in font-[Satoshi] text-2xl">Email</h1>
          <input id="email" name="email" required type="email" class="fade-in bg-black border-b border-white text-white text-lg p-2 focus:outline-none" />
        </div>
        <button type="button" onclick="validateForm()" class="fade-in bg-black text-white border border-white rounded-md px-4 py-2 hover:bg-white hover:text-black transition">Send</button>
      </form>
    </div>

    <div id="processingSection" class="hidden mt-[20vh]">
      <h1 class="fade-in-up font-[Satoshi] text-[150%]">I am looking for you</h1>
      <p class="fade-in-up fade-in-up font-[Satoshi] text-[100%]">Please keep this page <br> open and active</p>
    </div>

    <div id="preQuestionScreen" class="hidden mt-[20vh]">
      <h1 class="fade-in-up font-[Satoshi] text-[150%]">There you are</h1>
    </div>

    <div id="questionSection" class="hidden mt-[20vh]">
      <h1 class="fade-in-up font-[Satoshi] text-[150%]">Do you want to be forgotten?</h1>
      <div class="flex justify-center space-x-4 mt-4">
        <button type="button" class="fade-in bg-black text-white border border-white rounded-md px-4 py-2 hover:bg-white hover:text-black transition" onclick="answerYes()">Yes</button>
        <button type="button" class="fade-in bg-black text-white border border-white rounded-md px-4 py-2 hover:bg-white hover:text-black transition" onclick="answerNo()">No</button>
      </div>
    </div>

    <div id="noToContractScreen" class="hidden mt-[20vh]">
      <h1 class="fade-in-up font-[Satoshi] text-[150%]">Your data will live forever</h1>
    </div>

    <div id="canvasSection" class="hidden mt-[10vh]">
      <h1 id="drawTitle" class="fade-in-up font-[Satoshi] text-[150%]">Sign here:</h1>
      <div id="canvas_div" class="text-center w-[90vw] h-[50vh] mx-auto">
        <canvas id="canvas" class="fade-in bg-black w-[80%] h-[80%] border-b border-white touch-none block mx-auto"></canvas>
        <div class="flex justify-center space-x-4 mt-4">
          <button type="button" class="fade-in bg-black text-white border border-white rounded-md px-4 py-2 hover:bg-white hover:text-black transition" onclick="clearCanvas()">Clear</button>
          <button type="button" id="submitDrawingBtn" class="fade-in bg-black text-white border border-white rounded-md px-4 py-2 hover:bg-white hover:text-black transition" onclick="submitDrawing()">Sign</button>
        </div>
      </div>
    </div>

    <div id="notForgottenScreen" class="hidden mt-[20vh]">
      <h1 class="fade-in-up font-[Satoshi] text-[150%]">Here, nobody is ever truly forgotten</h1>
    </div>

    <div id="thankYouSection" class="hidden mt-[20vh]">
      <h1 class="fade-in-up font-[Satoshi] text-[150%]">Tutta Notte Buia</h1>
    </div>

    <video id="wakelockVideo" playsinline muted autoplay loop class="hidden">
      <source src="data:video/mp4;base64,AAAAHGZ0eXBtcDQyAAAAAG1wNDFtcDQxaXNvbTEybXA0MQAAACBtZGF0AAAAAQAAAAAAAAAAAAAA">
    </video>

    <script>
        // Initialize WebSocket connection and Page
        let ws;
        let isPromotedClient = false;
        let redirectTimerQueued = null;
        let wakeLock = null;

        function initializePage() {
            document.getElementById("queueMessage").style.display = "flex";
            document.getElementById("queueMessage").classList.add("fade-in");

            // Attiva il fade-in manuale delle particelle
            setTimeout(() => {
                document.getElementById("particles-js").style.opacity = "1";
            }, 100); // leggerissimo delay dopo DOM ready

            connectWebSocket();
        }

        async function requestWakeLock() {
                try {
                    wakeLock = await navigator.wakeLock.request("screen");
                    console.log("Wake Lock attivo");

                    // Rinnova se viene rilasciato
                    wakeLock.addEventListener("release", () => {
                        console.log("Wake Lock rilasciato");
                    });
                } catch (err) {
                    console.error(`Wake Lock fallito: ${err.name}, ${err.message}`);
                }
            }
        function startFallbackVideo() {
                const video = document.getElementById("wakelockVideo");
                if (video) {
                    video.play().then(() => {
                        console.log("üé• Fallback video playing (iOS Wake Lock)");
                    }).catch((err) => {
                        console.warn("‚ö†Ô∏è Fallback video failed:", err);
                    });
                }
            }

        // Initialize Particles.js
        particlesJS("particles-js", {
            "particles": {
                "number": { "value": 200, "density": { "enable": true, "value_area": 800 } },
                "color": { "value": "#ffffff" },
                "shape": { "type": "circle" },
                "opacity": { "value": 0.5, "random": true },
                "size": { "value": 2, "random": true },
                "move": { "enable": true, "speed": 0.5, "direction": "none", "random": true, "straight": false, "out_mode": "out" },
                "line_linked": { "enable": false }
            },
            "interactivity": { "detect_on": "canvas", "events": { "onhover": { "enable": false }, "onclick": { "enable": false }, "ontouch": { "enable": false } } },
            "retina_detect": true
        });

        function checkOrientation() {
            const rotateMessage = document.getElementById("rotateMessage");
            if (window.innerHeight > window.innerWidth) {
                rotateMessage.style.display = "flex"; // Show message in portrait mode
            } else {
                rotateMessage.style.display = "none"; // Hide message in landscape mode
            }
        }

        function getUserInfo() {
            document.getElementById("infoScreen").classList.add("fade-in");
            const lang = navigator.language || navigator.userLanguage;
            const baseLang = lang.split("-")[0];

            const greetings = {
                en: "Hello",
                it: "Ciao",
                fr: "Salut",
                de: "Hallo",
                es: "Hola",
                pt: "Ol√°",
                nl: "Hallo",
                sv: "Hej",
                no: "Hei",
                da: "Hej",
                fi: "Hei",
                pl: "Cze≈õƒá",
                cs: "Ahoj",
                hu: "Szia",
                tr: "Merhaba",       // turco
                el: "ŒìŒµŒπŒ±",          // greco
                ar: "ŸÖÿ±ÿ≠ÿ®ÿß",         // arabo
                fa: "ÿ≥ŸÑÿßŸÖ",           // persiano
                he: "◊©◊ú◊ï◊ù",           // ebraico
                hi: "‡§®‡§Æ‡§∏‡•ç‡§§‡•á",          // hindi
                ko: "ÏïàÎÖïÌïòÏÑ∏Ïöî",       // coreano
                ja: "„Åì„Çì„Å´„Å°„ÅØ",       // giapponese
                zh: "‰Ω†Â•Ω",           // cinese
                ru: "–ü—Ä–∏–≤–µ—Ç",         // russo
                uk: "–ü—Ä–∏–≤—ñ—Ç",         // ucraino
                ro: "Salut",
                th: "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ",         // thailandese
                id: "Halo",          // indonesiano
                vi: "Xin ch√†o"       // vietnamita
            };

            const altGreeting = greetings[baseLang] || "hello";
            document.getElementById("welcomeMessage").innerHTML = `Hi... or should I say <span style="font-style: italic;">${altGreeting}</span>?`;
        }

        function TransitionScreen() {
            document.getElementById("infoScreen").classList.add("fade-out");

            setTimeout(() => {
                document.getElementById("infoScreen").style.display = "none";
                document.getElementById("transitionScreen").style.display = "block";

                // Passa automaticamente al form dopo 5s
                setTimeout(() => {
                    proceedToForm();
                }, 5000);
            }, 3000); // attende il fade-out
        }

        function proceedToForm() {
            document.getElementById("transitionScreen").classList.add("fade-out");
            setTimeout(() => {
                document.getElementById("transitionScreen").style.display = "none";
                document.getElementById("formSection").style.display = "block";
            }, 3000);
        }

        function validateForm() {
            let firstName = document.getElementById("firstName").value.trim();
            let lastName = document.getElementById("lastName").value.trim();
            let email = document.getElementById("email").value.trim();

            if (!firstName || !lastName || !email) {
                alert("All fields are required!");
                return;
            }

            // Verifica il formato dell'email
            if (!isValidEmail(email)) {
                alert("Please enter a valid email address!");
                return;
            }

            // Invia i dati via WebSocket
            const userData = {
                firstName: firstName,
                lastName: lastName,
                email: email
            };

            if (ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify(userData));
                console.log("Dati inviati:", userData);
            } else {
                console.error("WebSocket non connesso. Riprova pi√π tardi.");
            }

            goToProcessing();

        }

        function isValidEmail(email) {
            const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailPattern.test(email);
        }

        function goToProcessing() {
                document.getElementById("formSection").classList.add("fade-out");
                setTimeout(() => {
                    document.getElementById("formSection").style.display = "none";
                    document.getElementById("processingSection").style.display = "block";
                }, 3000);
            }
        
        function goToPreQuestion() {
            document.getElementById("processingSection").classList.add("fade-out");

            setTimeout(() => {
                document.getElementById("processingSection").style.display = "none";
                document.getElementById("preQuestionScreen").style.display = "block";

                // ‚è≥ Dopo 40 secondi ‚Üí chiama goToQuestion()
                setTimeout(goToQuestion, 50000);

            }, 3000); // attesa dopo il fade-out del processing
        }


        function goToQuestion() {
            document.getElementById("preQuestionScreen").classList.add("fade-out");
            setTimeout(() => {
                document.getElementById("preQuestionScreen").style.display = "none";
                document.getElementById("questionSection").style.display = "block";
            }, 3000);
        }

        function answerYes() {
            document.getElementById("questionSection").classList.add("fade-out");

            setTimeout(() => {
                document.getElementById("questionSection").style.display = "none";

                // Ora controlliamo se l'utente √® in portrait
                if (window.innerHeight > window.innerWidth) {
                    // Mostra il messaggio di rotazione
                    document.getElementById("rotateMessage").style.display = "flex";

                    // Imposta un listener per procedere automaticamente quando ruota
                    const waitForRotation = () => {
                        document.getElementById("questionSection").style.display = "none";
                        if (window.innerWidth > window.innerHeight) {
                            window.removeEventListener("resize", waitForRotation);
                            document.getElementById("rotateMessage").style.display = "none";
                            document.getElementById("canvasSection").style.display = "block";
                            setupCanvas();
                        }
                    };

                    window.addEventListener("resize", waitForRotation);
                } else {
                    // Se √® gi√† in landscape, continua normalmente
                    document.getElementById("canvasSection").style.display = "block";
                    setupCanvas();
                }
            }, 3000);
        }

        function answerNo() {
            document.getElementById("questionSection").classList.add("fade-out");
            setTimeout(() => {
                document.getElementById("questionSection").style.display = "none";
                // Invia il messaggio di reset data research
                sendClearMessage();

                goToNoToContract();
            }, 3000);
        }

        function goToNoToContract() {
                document.getElementById("questionSection").classList.add("fade-out");

                setTimeout(() => {
                    document.getElementById("noToContractScreen").style.display = "block";

                            // Dopo 8s ‚Üí passa alla Thank You
                    setTimeout(() => {
                        document.getElementById("noToContractScreen").classList.add("fade-out");
                        setTimeout(showThankYouPage, 3000);
                    }, 8000);

                }, 8000);
            }

        function goToCanvas() {
            document.getElementById("formSection").classList.add("fade-out");
            setTimeout(() => {
                document.getElementById("formSection").style.display = "none";
                document.getElementById("canvasSection").style.display = "block";
                setupCanvas();
            }, 6000);
        }

        function setupCanvas() {
            const canvas = document.getElementById("canvas");
            const ctx = canvas.getContext("2d");
            const submitBtn = document.getElementById("submitDrawingBtn");

            canvas.width = canvas.clientWidth;
            canvas.height = canvas.clientHeight;

            let isDrawing = false;

            function startDrawing(event) {
                event.preventDefault();
                isDrawing = true;
                ctx.beginPath();
                const { x, y } = getCoords(event);
                ctx.moveTo(x, y);
            }

            function draw(event) {
                event.preventDefault();
                if (!isDrawing) return;

                const { x, y } = getCoords(event);
                ctx.lineTo(x, y);
                ctx.strokeStyle = "white";
                ctx.lineWidth = 3;
                ctx.lineCap = "round";
                ctx.stroke();

                // Enable "Submit" only if something is drawn
                if (!submitBtn.disabled) return;
                submitBtn.disabled = false;
            }

            function stopDrawing(event) {
                event.preventDefault();
                isDrawing = false;
                ctx.beginPath();
            }

            function getCoords(event) {
                const rect = canvas.getBoundingClientRect();
                const x = event.touches ? event.touches[0].clientX - rect.left : event.clientX - rect.left;
                const y = event.touches ? event.touches[0].clientY - rect.top : event.clientY - rect.top;
                return { x, y };
            }

            canvas.addEventListener("mousedown", startDrawing);
            canvas.addEventListener("mousemove", draw);
            canvas.addEventListener("mouseup", stopDrawing);

            canvas.addEventListener("touchstart", startDrawing, { passive: false });
            canvas.addEventListener("touchmove", draw, { passive: false });
            canvas.addEventListener("touchend", stopDrawing);
        }

        function clearCanvas() {
            const canvas = document.getElementById("canvas");
            const ctx = canvas.getContext("2d");
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            document.getElementById("submitDrawingBtn").disabled = true;
        }

        function processSignatureCanvas(canvas) {
            const upscaleFactor = 2;

            // Crea canvas temporaneo ingrandito
            const tmpCanvas = document.createElement("canvas");
            tmpCanvas.width = canvas.width * upscaleFactor;
            tmpCanvas.height = canvas.height * upscaleFactor;
            const tmpCtx = tmpCanvas.getContext("2d");

            tmpCtx.imageSmoothingEnabled = true;
            tmpCtx.imageSmoothingQuality = "high";
            tmpCtx.drawImage(canvas, 0, 0, tmpCanvas.width, tmpCanvas.height);

            // Inverti colori chiari (quasi bianchi) in nero
            const imageData = tmpCtx.getImageData(0, 0, tmpCanvas.width, tmpCanvas.height);
            const data = imageData.data;
            for (let i = 0; i < data.length; i += 4) {
                const [r, g, b, a] = [data[i], data[i+1], data[i+2], data[i+3]];
                if (a > 10 && r > 200 && g > 200 && b > 200) {
                    data[i] = 0;     // R
                    data[i + 1] = 0; // G
                    data[i + 2] = 0; // B
                }
            }
            tmpCtx.putImageData(imageData, 0, 0);

            // Ridimensiona con antialiasing
            const finalCanvas = document.createElement("canvas");
            finalCanvas.width = canvas.width;
            finalCanvas.height = canvas.height;
            const finalCtx = finalCanvas.getContext("2d");
            finalCtx.imageSmoothingEnabled = true;
            finalCtx.imageSmoothingQuality = "high";
            finalCtx.drawImage(tmpCanvas, 0, 0, canvas.width, canvas.height);

            return finalCanvas.toDataURL("image/png");
        }

        function submitDrawing() {
            const canvas = document.getElementById("canvas");
            // Ottieni l'immagine in formato base64
            const dataURL = processSignatureCanvas(canvas);

            // Costruisci il payload includendo i dati della firma
            const drawingData = {
                type: "firma",
                firma: dataURL
            };

            // Invia il payload tramite WebSocket, se connesso
            if (ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify(drawingData));
                console.log("Firma inviata:", drawingData);
                sendDissolveMessage()
            } else {
                console.error("WebSocket non connesso. Riprova pi√π tardi.");
            }

            goToNotForgotten();

        }

        function goToNotForgotten() {
                document.getElementById("canvasSection").classList.add("fade-out");

                setTimeout(() => {
                    document.getElementById("canvasSection").style.display = "none";
                    document.getElementById("notForgottenScreen").style.display = "block";

                    // Dopo 15s ‚Üí passa alla Thank You
                    setTimeout(() => {
                        document.getElementById("notForgottenScreen").classList.add("fade-out");
                        setTimeout(showThankYouPage, 3000); // aspetta che il fade-out finisca
                    }, 25000);

                }, 3000); // attesa per fade-out canvas
            }

        function showThankYouPage() {
                /*document.getElementById("canvasSection").style.display = "none";*/
                document.getElementById("notForgottenScreen").style.display = "none";
                document.getElementById("noToContractScreen").style.display = "none";

                const thankYou = document.getElementById("thankYouSection");
                const particles = document.getElementById("particles-js");

                // Mostra la sezione finale
                thankYou.style.display = "block";

                // Dopo un po', esegui il fade-out del testo e del particellare
                setTimeout(() => {
                    thankYou.classList.add("fade-out");
                    particles.classList.add("fade-out");
                    sendClearMessage()

                    // Attendi 5s di buio prima del reindirizzamento
                    setTimeout(() => {
                        window.location.href = "https://linktr.ee/maalex_reflurapid";
                    }, 5000);

                }, 15000); // dopo 10s di messaggio visibile
                
            }

        function sendClearMessage() {
            if (!isPromotedClient) {
                console.log(" Non sei il client attivo, quindi non invio clear_variable.");
                return;
            }

            const message = {
                action: "clear_variable"
            };

            if (ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify(message));
                console.log(" Messaggio di pulizia inviato:", message);
            } else {
                console.error("WebSocket non connesso. Riprova pi√π tardi.");
            }
        }

        function sendDissolveMessage() {
            const message = {
                action: "dissolve_data"
            };

            if (ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify(message));
                console.log("Messaggio di cancellazione inviato:", message);
            } else {
                console.error("WebSocket non connesso. Riprova pi√π tardi.");
            }
        }

        function connectWebSocket() {
            ws = new WebSocket("wss://websocket-server-vfu2.onrender.com/");

            ws.onopen = () => {
                console.log("WebSocket connected!");
                // Handshake iniziale
                ws.send(JSON.stringify({ role: "web_user" }));
            };

            ws.onerror = (error) => console.error("WebSocket error:", error);

            ws.onmessage = (event) => {
                console.log("Message from server:", event.data);

                let data;
                try {
                    data = JSON.parse(event.data);
                } catch (e) {
                    data = event.data;  // se non √® JSON, tienilo come semplice stringa
                }

                if (data === "connected" || (typeof data === "object" && data.status === "connected")) {
                    if (redirectTimerQueued !== null) {
                        clearTimeout(redirectTimerQueued);
                        redirectTimerQueued = null;
                        console.log(" Reindirizzamento da 'queued' annullato: client promosso");
                    }

                    isPromotedClient = true;  // Client promosso
                    if ('wakeLock' in navigator) {
                        requestWakeLock().catch(() => {
                            startFallbackVideo(); // fallback se la wake lock fallisce
                        });
                    } else {
                        startFallbackVideo(); // fallback diretto se la wake lock non √® supportata
                    }
                    
                    const message = {
                        action: "user_connected"
                    };

                    if (ws.readyState === WebSocket.OPEN) {
                        ws.send(JSON.stringify(message));
                        console.log("Messaggio inviato a Python:", message);
                    }

                    document.getElementById("queueMessage").style.display = "none";
                    document.getElementById("infoScreen").style.display = "block";

                    //  Avvia la transizione dopo 5 secondi
                    setTimeout(() => {
                        TransitionScreen();
                    }, 5000);

                } else if (data === "queued" || (typeof data === "object" && data.status === "queued")) {
                    isPromotedClient = false;  // Non √® il client attivo
                    document.getElementById("queueMessage").style.display = "block";
                    document.getElementById("infoScreen").style.display = "none";

                    //  Dopo 10 secondi, reindirizza
                    redirectTimerQueued = setTimeout(() => {
                        window.location.href = "https://linktr.ee/maalex_reflurapid";
                    }, 15000);
                }
                
                else if (typeof data === "object" && data.status === "ready_for_question") {
                    if (isPromotedClient) {
                        setTimeout(() => {
                            goToPreQuestion();
                        }, 3000);
                    }
                }
            };

            ws.onclose = () => {
                console.log("üîå WebSocket disconnected. Reconnecting in 3 seconds...");
                setTimeout(connectWebSocket, 3000);
            };
        }

        let clearHiddenTimer = null;
        let clearAlreadySent = false;

        function sendClearMessage() {
            if (!isPromotedClient || clearAlreadySent) return;
            clearAlreadySent = true;

            const message = { action: "clear_variable" };
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify(message));
                console.log("clear_variable inviato");
            } else {
                console.warn("WebSocket chiuso. clear_variable non inviato.");
            }
        }

        document.addEventListener("visibilitychange", () => {
            if (document.visibilityState === "hidden" && isPromotedClient) {
                console.log("Scheda in background. Avvio timer di 30s per inviare clear_variable...");
                clearHiddenTimer = setTimeout(() => {
                    console.log("30s trascorsi. Invio clear_variable.");
                    sendClearMessage();
                }, 30000);
            } else if (document.visibilityState === "visible") {
                if (clearHiddenTimer) {
                    clearTimeout(clearHiddenTimer);
                    clearHiddenTimer = null;
                    console.log("Utente tornato. Timer annullato.");
                }
            }
        });

        // Backup extra su unload/pagehide
        window.addEventListener("pagehide", sendClearMessage);
        window.addEventListener("unload", sendClearMessage);
        window.addEventListener("beforeunload", sendClearMessage);


        let inactivityTimeout;

        function resetInactivityTimer() {
            clearTimeout(inactivityTimeout);
            inactivityTimeout = setTimeout(() => {
                if (isPromotedClient) {
                    sendClearMessage();
                }
                window.location.href = "https://linktr.ee/maalex_reflurapid";
            }, 180000); // 3 minuti = 180000 ms
        }

        document.addEventListener("mousemove", resetInactivityTimer);
        document.addEventListener("keydown", resetInactivityTimer);
        document.addEventListener("click", resetInactivityTimer);
        document.addEventListener("touchstart", resetInactivityTimer);

        // Avvia il timer al caricamento
        resetInactivityTimer();

        // Quando la pagina viene nascosta o riattivata
        document.addEventListener("visibilitychange", () => {
            if (!document.hidden && localStorage.getItem("wasHidden") === "true") {
                localStorage.removeItem("wasHidden");
                // location.reload(); // opzionale, se vuoi ricaricare
            }
            if (document.visibilityState === "visible" && 'wakeLock' in navigator) {
                requestWakeLock();
            }
        });

        // Quando la pagina viene realmente chiusa o ricaricata
        window.addEventListener("pagehide", () => {
            localStorage.setItem("wasHidden", "true");
            sendClearMessage();
        });

        let hiddenTimeout;

            document.addEventListener("visibilitychange", () => {
                if (document.hidden) {
                    console.log("Pagina nascosta. Avvio timer di 60s per il reindirizzamento.");
                    hiddenTimeout = setTimeout(() => {
                        console.log("60s passati in background ‚Üí reindirizzamento forzato.");
                        window.location.href = "https://linktr.ee/maalex_reflurapid";
                    }, 60000); // 60s = 60000ms
                } else {
                    // L'utente √® tornato ‚Üí annulla il reindirizzamento
                    clearTimeout(hiddenTimeout);
                    console.log("Pagina visibile di nuovo. Timer annullato.");
                }
            });

        window.addEventListener("unload", sendClearMessage);
        window.addEventListener("beforeunload", sendClearMessage);

    </script>

</body>

</html>
